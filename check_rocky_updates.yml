---
- name: V√©rifier l'√©tat de s√©curit√© et syst√®me de la machine Rocky Linux
  hosts: all
  become: yes
  gather_facts: yes  # Pour r√©cup√©rer les infos syst√®me

  tasks:
    - name: V√©rifier les mises √† jour de s√©curit√© (Critical & Important)
      shell: dnf updateinfo list security severity=Critical,Important || true
      register: dnf_security_updates
      changed_when: false

    - name: Extraire les lignes de mises √† jour
      set_fact:
        update_lines: "{{ dnf_security_updates.stdout_lines | select('match', '^RHSA') | list }}"

    - name: Compter les mises √† jour Critical
      set_fact:
        critical_updates: "{{ update_lines | select('search', 'Critical') | list | length }}"

    - name: Compter les mises √† jour Important
      set_fact:
        important_updates: "{{ update_lines | select('search', 'Important') | list | length }}"

    - name: R√©cup√©rer l'uptime
      shell: awk '{print int($1/3600)"h "int(($1%3600)/60)"m"}' /proc/uptime
      register: system_uptime
      changed_when: false

    - name: Afficher le r√©sum√© syst√®me et s√©curit√©
      debug:
        msg: |
          ‚úÖ Informations syst√®me :
          - OS       : {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Uptime   : {{ system_uptime.stdout }}

          üîê Mises √† jour de s√©curit√© :
          - Critiques : {{ critical_updates }}
          - Importantes : {{ important_updates }}
